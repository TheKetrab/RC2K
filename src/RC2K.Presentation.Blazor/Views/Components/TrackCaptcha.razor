@using RC2K.Presentation.Blazor.ViewModels

@implements IDisposable
@inject IJSRuntime JS

<!-- The goal of this component is to render reCAPTCHA badge only on pages where CAPTCHA mechanism is required -->

<!-- Google reCAPTCHA -->
<script src=@($"https://www.google.com/recaptcha/api.js?render={_recaptchaSiteKey}")></script>
<script>
  runCaptcha = function (actionName) {
    return new Promise((resolve, reject) => {
      grecaptcha.ready(function () {
        grecaptcha.execute('@($"{_recaptchaSiteKey}")', { action: 'submit' }).then(function (token) {
          resolve(token);
        });
      });
    });
  };
</script>
<script>
  setRecaptchaVisibility = function (visible) {
    const badge = document.querySelector('.grecaptcha-badge');
    if (badge) {
        debugger;
        badge.style.display = visible ? 'block' : 'none';
    }
  };
</script>

@code {

  private string _recaptchaSiteKey;

  public TrackCaptcha(IConfiguration configuration)
  {
    _recaptchaSiteKey = configuration["Captcha:SiteKey"];
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      await JS.InvokeVoidAsync("setRecaptchaVisibility", true);
    }
  }

  public void Dispose()
  {
    _ = JS.InvokeVoidAsync("setRecaptchaVisibility", false);
  }
}